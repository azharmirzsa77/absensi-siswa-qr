<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Barcode Sekolah</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --bg-color: #f4f7f6;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        .school-header img {
            width: 100px; /* Sesuaikan ukuran logo */
            height: auto;
            margin-bottom: 10px;
        }

        h2 {
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        p.subtitle {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        #reader {
            border: 2px solid var(--accent-color) !important;
            border-radius: 10px;
            overflow: hidden;
            background: #000;
        }

        .status-selection {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .status-btn {
            padding: 10px 25px;
            border: 2px solid #ddd;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        input[type="radio"] {
            display: none;
        }

            input[type="radio"]:checked + label {
                background-color: var(--accent-color);
                color: white;
                border-color: var(--accent-color);
            }

        #result-container {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none; /* Sembunyi jika kosong */
        }

        .success-msg {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error-msg {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60% {
                content: '...';
            }

            80%, 100% {
                content: '';
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="school-header">
            <img src="https://cdn-icons-png.flaticon.com/512/5351/5351461.png" alt="Logo Sekolah">
            <h2>E-Absensi Siswa</h2>
            <p class="subtitle">Arahkan Barcode/QR Code ke Kamera</p>
        </div>

        <div class="status-selection">
            <input type="radio" id="masuk" name="status" value="Masuk" checked>
            <label for="masuk" class="status-btn">Masuk</label>

            <input type="radio" id="pulang" name="status" value="Pulang">
            <label for="pulang" class="status-btn">Pulang</label>
        </div>

        <div id="reader"></div>

        <div id="result-container"></div>
    </div>

    <script>
        // 1. PASTIKAN URL WEB APP SUDAH VERSI TERBARU
        const webAppUrl = "https://script.google.com/macros/s/AKfycbxPdaULKuI3fcKEYI9K41FfLf2dvYiPGWQPon3nufA7RRYB4HzS3f3leKiAP_OOVY-Cgw/exec";

        const resultContainer = document.getElementById('result-container');

        function onScanSuccess(decodedText, decodedResult) {
            // Hentikan scanner agar tidak mengirim data berkali-kali
            html5QrcodeScanner.pause(true);

            let status = document.querySelector('input[name="status"]:checked').value;

            resultContainer.style.display = "block";
            resultContainer.className = "success-msg";
            resultContainer.innerHTML = `Memproses NIS: <b>${decodedText}</b>...`;

            // Kirim data menggunakan mode 'no-cors' jika terjadi error koneksi,
            // namun Fetch API standar biasanya bekerja jika deployment benar.
            fetch(`${webAppUrl}?nis=${decodedText}&status=${status}`, {
                method: 'GET',
                mode: 'cors'
            })
                .then(response => response.text())
                .then(data => {
                    resultContainer.innerHTML = `✅ ${data}`;
                    // Tunggu 3 detik sebelum siap scan lagi
                    setTimeout(() => {
                        resultContainer.style.display = "none";
                        html5QrcodeScanner.resume();
                    }, 3000);
                })
                .catch(err => {
                    resultContainer.className = "error-msg";
                    resultContainer.innerHTML = "❌ Gagal Terhubung ke Database. Pastikan internet aktif.";
                    setTimeout(() => { html5QrcodeScanner.resume(); }, 3000);
                });
        }

        // KONFIGURASI SCANNER UNTUK KAMERA BELAKANG
        let html5QrcodeScanner = new Html5QrcodeScanner(
            "reader",
            {
                fps: 20,
                qrbox: { width: 250, height: 250 },
                // Menambahkan pengaturan untuk mengutamakan kamera belakang (environment)
                videoConstraints: {
                    facingMode: { exact: "environment" }
                }
            }
        );

        html5QrcodeScanner.render(onScanSuccess);
    </script>

</body>
</html>
